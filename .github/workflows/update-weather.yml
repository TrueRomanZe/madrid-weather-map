# ============================================================================
# Workflow de GitHub Actions para actualizaci√≥n autom√°tica de datos meteorol√≥gicos
# ============================================================================
#
# Este workflow se encarga de ejecutar el script de Python que consulta
# la API de OpenWeatherMap y actualiza los datos del clima para todos
# los municipios de la Comunidad de Madrid.
#
# El workflow se ejecuta autom√°ticamente cada 3 horas, pero tambi√©n puede
# ejecutarse manualmente desde la interfaz de GitHub o cuando se hace push
# a la rama principal (√∫til para pruebas).
#
# ============================================================================

name: Actualizar Datos Meteorol√≥gicos

# Definir los eventos que disparan este workflow
on:
  # Ejecuci√≥n programada cada 3 horas
  # Cron usa horario UTC (restar 1-2 horas para horario de Madrid seg√∫n temporada)
  # Formato: minuto hora d√≠a mes d√≠a_semana
  # "0 */3 * * *" significa: en el minuto 0 de cada 3 horas, todos los d√≠as
  schedule:
    - cron: '0 */3 * * *'
  
  # Permite ejecutar manualmente el workflow desde la pesta√±a Actions
  # Esto es muy √∫til para probar cambios o forzar una actualizaci√≥n
  workflow_dispatch:
  
  # Se ejecuta cuando se hace push a la rama main
  # Esto facilita las pruebas despu√©s de hacer cambios en el c√≥digo
  push:
    branches: 
      - main

# Definir los trabajos (jobs) que se ejecutar√°n
jobs:
  # Job √∫nico que actualiza los datos meteorol√≥gicos
  update-weather:
    # Usar la √∫ltima versi√≥n de Ubuntu como entorno de ejecuci√≥n
    runs-on: ubuntu-latest
    
    # Permisos necesarios para que el workflow pueda modificar el repositorio
    # 'contents: write' permite hacer commits y push de archivos modificados
    permissions:
      contents: write
    
    # Pasos que se ejecutar√°n secuencialmente
    steps:
      # ======================================================================
      # PASO 1: Descargar el c√≥digo del repositorio
      # ======================================================================
      - name: üì• Checkout del repositorio
        uses: actions/checkout@v4
        with:
          # Usar un token con permisos para hacer push
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # ======================================================================
      # PASO 2: Configurar el entorno Python
      # ======================================================================
      - name: üêç Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # ======================================================================
      # PASO 3: Instalar dependencias de Python
      # ======================================================================
      - name: üì¶ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      # ======================================================================
      # PASO 4: Ejecutar el script de actualizaci√≥n
      # ======================================================================
      - name: üå§Ô∏è Ejecutar script de actualizaci√≥n meteorol√≥gica
        env:
          # Pasar la API key como variable de entorno de forma segura
          # El secret debe estar configurado en Settings > Secrets del repo
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
        run: |
          echo "Iniciando actualizaci√≥n de datos meteorol√≥gicos..."
          python update_weather.py
          echo "Script ejecutado correctamente"
      
      # ======================================================================
      # PASO 5: Verificar si hay cambios en los datos
      # ======================================================================
      - name: üîç Verificar cambios en los datos
        id: verify_changes
        run: |
          # A√±adir el archivo al staging area de git
          git add data/weather_data.json
          
          # Verificar si hay cambios usando git diff
          # --cached compara el staging area con el √∫ltimo commit
          # --quiet no produce output, solo el exit code
          if git diff --cached --quiet; then
            echo "No hay cambios en los datos meteorol√≥gicos"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Se detectaron cambios en los datos meteorol√≥gicos"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      # ======================================================================
      # PASO 6: Guardar los cambios en el repositorio (solo si hay cambios)
      # ======================================================================
      - name: üíæ Commit y push de datos actualizados
        if: steps.verify_changes.outputs.has_changes == 'true'
        run: |
          # Configurar git con identidad del bot de GitHub Actions
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Crear commit con mensaje descriptivo que incluye fecha y hora
          git commit -m "üå§Ô∏è Actualizaci√≥n autom√°tica de datos meteorol√≥gicos - $(date +'%d/%m/%Y %H:%M UTC')"
          
          # Hacer push de los cambios al repositorio
          git push
          
          echo "‚úÖ Datos actualizados y guardados en el repositorio"
      
      # ======================================================================
      # PASO 7: Notificar si no hubo cambios
      # ======================================================================
      - name: ‚ÑπÔ∏è Notificar ausencia de cambios
        if: steps.verify_changes.outputs.has_changes == 'false'
        run: |
          echo "‚ÑπÔ∏è Los datos meteorol√≥gicos no han cambiado desde la √∫ltima actualizaci√≥n"
          echo "Esto es completamente normal y significa que las condiciones clim√°ticas"
          echo "son similares a las de la consulta anterior."
